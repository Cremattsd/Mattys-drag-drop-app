<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maverick & Goose Chat</title>
    <link rel="stylesheet" href="static/styles.css">
</head>
<body>
    <div class="chatbox">
        <div class="chat-header">
            <img id="avatar" src="static/maverick-avatar.png" alt="Maverick" />
            <span id="chat-name">Chat with Maverick</span>
            <span id="status">Weâ€™re online</span>
            <button id="minimize-btn" onclick="toggleChatbox()">-</button>
        </div>
        <div class="messages" id="messages"></div>

        <!-- Quick Response Buttons -->
        <div id="response-buttons"></div>

        <div class="input-container">
            <input type="text" id="message-input" placeholder="Enter your message..." />
            <button id="send-btn">Send</button>
        </div>

        <!-- Emoji and Attachment Buttons -->
        <div class="emoji-attachment">
            <button id="emoji-btn">ðŸ˜Š</button>
            <button id="attachment-btn" onclick="triggerAttachment()">ðŸ“Ž</button>
            <input type="file" id="file-input" accept="image/*" style="display:none" onchange="uploadBusinessCard(event)">
        </div>
    </div>

    <script>
        let role = "maverick";  // Default role
        const messagesDiv = document.getElementById("messages");
        const messageInput = document.getElementById("message-input");
        const sendBtn = document.getElementById("send-btn");
        const responseButtonsDiv = document.getElementById("response-buttons");
        const minimizeBtn = document.getElementById("minimize-btn");

        // Toggle chatbox visibility
        const toggleChatbox = () => {
            const chatbox = document.querySelector('.chatbox');
            chatbox.style.display = chatbox.style.display === 'none' ? 'block' : 'none';
        };

        const changeRole = (newRole) => {
            role = newRole;
            const avatar = document.getElementById("avatar");
            const chatName = document.getElementById("chat-name");
            const status = document.getElementById("status");

            if (role === "maverick") {
                avatar.src = "static/maverick-avatar.png";
                chatName.textContent = "Chat with Maverick";
                status.textContent = "Weâ€™re online";
            } else {
                avatar.src = "static/goose-avatar.png";
                chatName.textContent = "Chat with Goose";
                status.textContent = "Ready to help with data uploads";
            }
        };

        const sendMessage = async () => {
            const message = messageInput.value;
            if (message.trim() === "") return;

            // Display user message
            messagesDiv.innerHTML += `<div class="message user-message">${message}</div>`;
            messageInput.value = "";

            // Call backend to get the chatbot's response
            const response = await fetch("/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message: message, role: role })
            });
            const data = await response.json();

            // Display AI response
            messagesDiv.innerHTML += `<div class="message ai-message">${data.response}</div>`;

            // Display quick response buttons
            if (data.response.includes("Import data")) {
                responseButtonsDiv.innerHTML = `
                    <button onclick="handleQuickResponse('Import data')">Import data</button>
                `;
            }

            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        };

        const handleQuickResponse = (response) => {
            messageInput.value = response;
            sendMessage();
        };

        sendBtn.addEventListener("click", sendMessage);
        messageInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
                sendMessage();
            }
        });

        // Function to trigger file input for attachments
        const triggerAttachment = () => {
            document.getElementById("file-input").click();
        };

        // Function to handle business card uploads
        const uploadBusinessCard = async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append("file", file);

            // Display user message
            messagesDiv.innerHTML += `<div class="message user-message">Uploading business card...</div>`;

            // Call backend to process the uploaded file
            const response = await fetch("/upload", {
                method: "POST",
                body: formData
            });
            const data = await response.json();

            // Display AI response
            messagesDiv.innerHTML += `<div class="message ai-message">${data.extracted_data}</div>`;

            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        };
    </script>
</body>
</html>
