<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goose & Maverick</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="/css/tailwind.css" rel="stylesheet">
    <script src="/js/chart.js"></script>
    <script src="/js/socket.io.min.js"></script>
    <script src="/js/voice.js"></script>
    <script>
        // Ensure io is defined globally from SocketIO
        const io = window.SocketIO ? window.SocketIO.io : window.io;
        if (!io) {
            console.error("Socket.io 'io' function is not defined. Check if socket.io.min.js is loaded correctly.");
        }
    </script>
    <style>
        body {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            font-family: 'Inter', sans-serif;
            color: #1f2937;
        }
        .chat-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 380px;
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }
        .chat-header {
            background: linear-gradient(to right, #8b5cf6, #22d3ee);
            color: white;
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }
        .chat-header img, .chat-header svg {
            width: 20px;
            height: 20px;
            margin-right: 6px;
            transition: transform 0.3s ease;
        }
        .chat-header img:hover, .chat-header svg:hover {
            transform: scale(1.1);
        }
        .chat-title-container {
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }
        .button-container {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            gap: 6px;
            scrollbar-width: thin;
            scrollbar-color: #a78bfa #ffffff;
        }
        .button-container::-webkit-scrollbar {
            height: 4px;
        }
        .button-container::-webkit-scrollbar-track {
            background: #ffffff;
        }
        .button-container::-webkit-scrollbar-thumb {
            background: #a78bfa;
            border-radius: 4px;
        }
        .chat-body {
            padding: 16px;
            max-height: 400px;
            overflow-y: auto;
            background: #fafafa;
        }
        .chat-message {
            margin-bottom: 12px;
            padding: 10px 14px;
            border-radius: 12px;
            background: #f3f4f6;
            color: #1f2937;
            transition: all 0.3s ease;
        }
        .chat-message.bg-purple-100 {
            background: #8b5cf6;
            color: white;
        }
        .chat-message.bg-teal-100 {
            background: #14b8a6;
            color: white;
        }
        .chat-message.bg-red-100 {
            background: #ef4444;
            color: white;
        }
        .chat-input {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-top: 1px solid #e5e7eb;
            background: #ffffff;
        }
        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            margin-right: 8px;
            background: #f9fafb;
            color: #1f2937;
        }
        .chat-input input::placeholder {
            color: #6b7280;
        }
        .chat-input button {
            background: #8b5cf6;
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            transition: background 0.3s ease, transform 0.1s ease;
        }
        .chat-input button:hover {
            background: #a78bfa;
            transform: scale(1.03);
        }
        .voice-button {
            background: #14b8a6;
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin-right: 8px;
            transition: background 0.3s ease, transform 0.1s ease;
        }
        .voice-button:hover {
            background: #2dd4bf;
            transform: scale(1.03);
        }
        .voice-button.recording {
            background: #ef4444;
        }
        .switch-button, .clear-key-button, .dashboard-button, .toggle-events-button, .sync-mailchimp-button {
            background: #ffffff;
            color: #8b5cf6;
            border: 1px solid #8b5cf6;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            transition: background 0.3s ease, transform 0.1s ease;
            white-space: nowrap;
        }
        .switch-button:hover, .clear-key-button:hover, .dashboard-button:hover, .toggle-events-button:hover, .sync-mailchimp-button:hover {
            background: #f3e8ff;
            transform: scale(1.03);
        }
        .drag-drop-area {
            border: 2px dashed #8b5cf6;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            margin-bottom: 12px;
            background: #f9fafb;
            color: #6b7280;
            transition: all 0.3s ease;
        }
        .drag-drop-area.dragover {
            background: #ede9fe;
            color: #8b5cf6;
            border-color: #a78bfa;
        }
        .dynamic-form {
            margin-bottom: 12px;
        }
        .dynamic-form input,
        .dynamic-form textarea,
        .dynamic-form select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #f9fafb;
            color: #1f2937;
        }
        .dynamic-form input::placeholder,
        .dynamic-form textarea::placeholder {
            color: #6b7280;
        }
        .dynamic-form button {
            background: #14b8a6;
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            transition: background 0.3s ease, transform 0.1s ease;
        }
        .dynamic-form button:hover {
            background: #2dd4bf;
            transform: scale(1.03);
        }
        .standalone-header {
            display: block;
        }
        @media (display-mode: embedded) {
            .standalone-header {
                display: none;
            }
        }
        .icon-container {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 8px;
        }
        .icon-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 12px;
            color: #6b7280;
        }
        .icon-label img, .icon-label svg {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
        }
        .sync-gauge {
            margin-top: 12px;
            max-width: 200px;
            margin-left: auto;
            margin-right: auto;
        }
        .spinner {
            display: none;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #8b5cf6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <header class="standalone-header bg-gradient-to-r from-purple-600 to-teal-500 text-white p-4">
        <h1 class="text-2xl font-bold">Goose & Maverick</h1>
    </header>

    <div class="chat-widget">
        <div class="chat-header">
            <div class="chat-title-container">
                <img id="mode-icon" src="/maverick-icon.png" alt="Maverick Icon" onerror="this.style.display='none'; document.getElementById('maverick-svg').style.display='block';">
                <svg id="maverick-svg" style="display: none;" viewBox="0 0 24 24" fill="white">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                </svg>
                <span id="chat-title">Hey there! Chat with Maverick! üöÄ</span>
            </div>
            <div class="button-container">
                <a href="/dashboard" target="_blank" class="dashboard-button">Dashboard</a>
                <button id="switch-mode" class="switch-button" onclick="toggleMode()">Switch to Goose</button>
                <button id="clear-key" class="clear-key-button" onclick="clearStoredKey()" style="display: none;">Clear Key</button>
                <button id="toggle-events" class="toggle-events-button" onclick="toggleEvents()" style="display: none;">Enable Event Alerts</button>
                <button id="sync-mailchimp" class="sync-mailchimp-button" onclick="syncMailchimp()" style="display: none;">Sync to Mailchimp</button>
            </div>
        </div>
        <div class="chat-body" id="chat-body">
            <div id="welcome-message" class="chat-message bg-purple-100">
                Hi! I‚Äôm Maverick, your chat assistant. Ask me anything about RealNex, Zendesk, webinars, Pix-Virtual, or more! üòä
            </div>
            <canvas id="sync-gauge" class="sync-gauge"></canvas>
        </div>
        <div class="chat-input">
            <button id="start-voice" class="voice-button">üéôÔ∏è</button>
            <input type="text" id="chat-message" placeholder="Type or speak your message..." onkeypress="if(event.key === 'Enter') sendMessage()">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        let mode = 'maverick';
        let token = localStorage.getItem('realNexApiKey') || '';
        let currentFile = null;
        let eventsEnabled = false;
        const socket = io('/chat');

        socket.on('notification', (data) => {
            const chatBody = document.getElementById('chat-body');
            const message = document.createElement('div');
            message.className = 'chat-message bg-teal-100';
            message.innerText = data.message;
            chatBody.insertBefore(message, document.getElementById('sync-gauge'));
            chatBody.scrollTop = chatBody.scrollHeight;
        });

        window.onload = function() {
            const clearKeyButton = document.getElementById('clear-key');
            const welcomeMessage = document.getElementById('welcome-message');
            welcomeMessage.style.opacity = '0';
            welcomeMessage.style.transition = 'opacity 1s ease-in';
            setTimeout(() => { welcomeMessage.style.opacity = '1'; }, 100);
            if (token && mode === 'goose') {
                clearKeyButton.style.display = 'block';
                document.getElementById('toggle-events').style.display = 'block';
                document.getElementById('sync-mailchimp').style.display = 'block';
            } else {
                clearKeyButton.style.display = 'none';
                document.getElementById('toggle-events').style.display = 'none';
                document.getElementById('sync-mailchimp').style.display = 'none';
            }
            setupGauge();
        };

        function toggleMode() {
            const switchButton = document.getElementById('switch-mode');
            const chatTitle = document.getElementById('chat-title');
            const modeIcon = document.getElementById('mode-icon');
            const maverickSvg = document.getElementById('maverick-svg');
            const clearKeyButton = document.getElementById('clear-key');
            const toggleEventsButton = document.getElementById('toggle-events');
            const syncMailchimpButton = document.getElementById('sync-mailchimp');
            if (mode === 'maverick') {
                mode = 'goose';
                chatTitle.innerText = 'Let‚Äôs Scan with Goose! üì∏';
                switchButton.innerText = 'Switch to Maverick';
                modeIcon.src = '/goose-icon.png';
                modeIcon.alt = 'Goose Icon';
                modeIcon.onerror = () => {
                    modeIcon.style.display = 'none';
                    const gooseSvg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                    gooseSvg.setAttribute("viewBox", "0 0 24 24");
                    gooseSvg.setAttribute("fill", "white");
                    gooseSvg.innerHTML = '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>';
                    gooseSvg.classList.add('w-6', 'h-6', 'mr-2');
                    modeIcon.parentNode.insertBefore(gooseSvg, modeIcon);
                };
                maverickSvg.style.display = 'none';
                if (token) {
                    setupDragDropArea();
                    clearKeyButton.style.display = 'block';
                    toggleEventsButton.style.display = 'block';
                    syncMailchimpButton.style.display = 'block';
                } else {
                    document.getElementById('chat-body').innerHTML = `
                        <div class="dynamic-form">
                            <input type="text" id="token-input" placeholder="Enter your RealNex Bearer Token">
                            <button onclick="validateToken()">Validate Token</button>
                        </div>
                        <canvas id="sync-gauge" class="sync-gauge"></canvas>`;
                    clearKeyButton.style.display = 'none';
                    toggleEventsButton.style.display = 'none';
                    syncMailchimpButton.style.display = 'none';
                    setupGauge();
                }
            } else {
                mode = 'maverick';
                chatTitle.innerText = 'Hey there! Chat with Maverick! üöÄ';
                switchButton.innerText = 'Switch to Goose';
                modeIcon.src = '/maverick-icon.png';
                modeIcon.alt = 'Maverick Icon';
                modeIcon.onerror = () => {
                    modeIcon.style.display = 'none';
                    maverickSvg.style.display = 'block';
                };
                if (document.querySelector('svg:not(#maverick-svg)')) {
                    document.querySelector('svg:not(#maverick-svg)').remove();
                }
                document.getElementById('chat-body').innerHTML = `
                    <div id="welcome-message" class="chat-message bg-purple-100">
                        Hi! I‚Äôm Maverick, your chat assistant. Ask me anything about RealNex, Zendesk, webinars, Pix-Virtual, or more! üòä
                    </div>
                    <canvas id="sync-gauge" class="sync-gauge"></canvas>`;
                clearKeyButton.style.display = 'none';
                toggleEventsButton.style.display = 'none';
                syncMailchimpButton.style.display = 'none';
                setupGauge();
            }
        }

        function clearStoredKey() {
            localStorage.removeItem('realNexApiKey');
            token = '';
            eventsEnabled = false;
            const chatBody = document.getElementById('chat-body');
            const clearKeyButton = document.getElementById('clear-key');
            const toggleEventsButton = document.getElementById('toggle-events');
            const syncMailchimpButton = document.getElementById('sync-mailchimp');
            if (mode === 'goose') {
                chatBody.innerHTML = `
                    <div class="dynamic-form">
                        <input type="text" id="token-input" placeholder="Enter your RealNex Bearer Token">
                        <button onclick="validateToken()">Validate Token</button>
                    </div>
                    <canvas id="sync-gauge" class="sync-gauge"></canvas>`;
                clearKeyButton.style.display = 'none';
                toggleEventsButton.style.display = 'none';
                syncMailchimpButton.style.display = 'none';
                setupGauge();
            }
        }

        async function toggleEvents() {
            const toggleButton = document.getElementById('toggle-events');
            const chatBody = document.getElementById('chat-body');
            if (!eventsEnabled) {
                const emailForm = document.createElement('div');
                emailForm.className = 'dynamic-form';
                emailForm.innerHTML = `
                    <input type="email" id="email-input" placeholder="Enter your email for alerts">
                    <select id="priority-filter" class="mb-2">
                        <option value="high">High Priority Only</option>
                        <option value="any">Any Priority</option>
                    </select>
                    <div class="flex items-center mb-2">
                        <input type="checkbox" id="alarm-filter" class="mr-2">
                        <label for="alarm-filter">Require Alarm</label>
                    </div>
                    <input type="number" id="due-date-days" placeholder="Due within days (e.g., 7)" value="7">
                    <button onclick="enableEvents()">Enable Alerts</button>
                `;
                chatBody.insertBefore(emailForm, document.getElementById('sync-gauge'));
                chatBody.scrollTop = chatBody.scrollHeight;
            } else {
                try {
                    const res = await fetch('/toggle-events', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ enable: false })
                    });
                    const data = await res.json();
                    eventsEnabled = false;
                    toggleButton.innerText = 'Enable Event Alerts';
                    const message = document.createElement('div');
                    message.className = 'chat-message bg-teal-100';
                    message.innerText = data.message;
                    chatBody.insertBefore(message, document.getElementById('sync-gauge'));
                    chatBody.scrollTop = chatBody.scrollHeight;
                } catch (e) {
                    const errorMessage = document.createElement('div');
                    errorMessage.className = 'chat-message bg-red-100';
                    errorMessage.innerText = 'Turbulence: ' + e.message;
                    chatBody.insertBefore(errorMessage, document.getElementById('sync-gauge'));
                    chatBody.scrollTop = chatBody.scrollHeight;
                }
            }
        }

        async function enableEvents() {
            const emailInput = document.getElementById('email-input');
            const priorityFilter = document.getElementById('priority-filter').value;
            const alarmFilter = document.getElementById('alarm-filter').checked;
            const dueDateDays = parseInt(document.getElementById('due-date-days').value) || 7;
            const email = emailInput.value.trim();
            const chatBody = document.getElementById('chat-body');
            const toggleButton = document.getElementById('toggle-events');
            if (!email) {
                const errorMessage = document.createElement('div');
                errorMessage.className = 'chat-message bg-red-100';
                errorMessage.innerText = 'Please enter a valid email!';
                chatBody.insertBefore(errorMessage, document.getElementById('sync-gauge'));
                chatBody.scrollTop = chatBody.scrollHeight;
                return;
            }

            try {
                const res = await fetch('/toggle-events', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ 
                        enable: true, 
                        email, 
                        priority_filter: priorityFilter,
                        alarm_filter: alarmFilter,
                        due_date_days: dueDateDays
                    })
                });
                const data = await res.json();
                eventsEnabled = true;
                toggleButton.innerText = 'Disable Event Alerts';
                const message = document.createElement('div');
                message.className = 'chat-message bg-teal-100';
                message.innerText = data.message;
                chatBody.innerHTML = `
                    <div class="drag-drop-area" id="drag-drop-area">
                        Drop a photo, PDF, or Excel file here to scan or import‚Äîsuper easy! üéâ
                        <div class="icon-container">
                            <div class="icon-label">
                                <img src="/attachment-icon.png" alt="Attachment Icon" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <svg style="display: none;" viewBox="0 0 24 24" fill="#8b5cf6">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 2l5 5h-5V4zM6 20V4h6v6h6v10H6z"/>
                                </svg>
                                Attachment
                            </div>
                            <div class="icon-label">
                                <img src="/business-card-icon.png" alt="Business Card Icon" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <svg style="display: none;" viewBox="0 0 24 24" fill="#8b5cf6">
                                    <path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h16v12zM6 8h12v2H6V8zm0 4h12v2H6v-2z"/>
                                </svg>
                                Business Card
                            </div>
                            <div class="icon-label">
                                <img src="/photo-ocr-icon.png" alt="Photo OCR Icon" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <svg style="display: none;" viewBox="0 0 24 24" fill="#8b5cf6">
                                    <path d="M21 7h-6V5c0-1.1-.9-2-2-2H9c-1.1 0-2 .9-2 2v2H3c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h18c1.1 0 2-.9-2 2V9c0-1.1-.9-2-2-2zM9 5h4v2H9V5zm11 14H4V9h16v10z"/>
                                </svg>
                                Photo OCR
                            </div>
                        </div>
                        <input type="file" id="chat-file" accept="image/*,.pdf,.xlsx" style="display: none;">
                    </div>
                    <canvas id="sync-gauge" class="sync-gauge"></canvas>`;
                chatBody.insertBefore(message, document.getElementById('sync-gauge'));
                setupDragDrop();
                setupGauge();
                chatBody.scrollTop = chatBody.scrollHeight;
            } catch (e) {
                const errorMessage = document.createElement('div');
                errorMessage.className = 'chat-message bg-red-100';
                errorMessage.innerText = 'Turbulence: ' + e.message;
                chatBody.insertBefore(errorMessage, document.getElementById('sync-gauge'));
                chatBody.scrollTop = chatBody.scrollHeight;
            }
        }

        async function syncMailchimp() {
            const chatBody = document.getElementById('chat-body');
            try {
                const res = await fetch('/mailchimp-info', {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error);

                const syncForm = document.createElement('div');
                syncForm.className = 'dynamic-form';
                syncForm.innerHTML = `
                    <input type="text" id="mailchimp-api-key" placeholder="Enter Mailchimp API Key (optional)">
                    <select id="realnex-group" class="mb-2">
                        ${data.realnex_groups.map(g => `<option value="${g.id}">${g.name}</option>`).join('')}
                    </select>
                    <select id="mailchimp-audience" class="mb-2">
                        ${data.mailchimp_audiences.map(a => `<option value="${a.id}">${a.name}</option>`).join('')}
                    </select>
                    <button onclick="performMailchimpSync

()">Sync to Mailchimp</button>
                `;
                chatBody.insertBefore(syncForm, document.getElementById('sync-gauge'));
                chatBody.scrollTop = chatBody.scrollHeight;
            } catch (e) {
                const errorMessage = document.createElement('div');
                errorMessage.className = 'chat-message bg-red-100';
                errorMessage.innerText = 'Turbulence: ' + e.message;
                chatBody.insertBefore(errorMessage, document.getElementById('sync-gauge'));
                chatBody.scrollTop = chatBody.scrollHeight;
            }
        }

        async function performMailchimpSync() {
            const groupId = document.getElementById('realnex-group').value;
            const audienceId = document.getElementById('mailchimp-audience').value;
            const mailchimpApiKey = document.getElementById('mailchimp-api-key').value.trim();
            const chatBody = document.getElementById('chat-body');
            try {
                const res = await fetch('/sync-mailchimp', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ group_id: groupId, audience_id: audienceId, mailchimp_api_key: mailchimpApiKey })
                });
                const data = await res.json();
                const message = document.createElement('div');
                message.className = 'chat-message bg-teal-100';
                message.innerText = data.message || data.error;
                chatBody.innerHTML = `
                    <div class="drag-drop-area" id="drag-drop-area">
                        Drop a photo, PDF, or Excel file here to scan or import‚Äîsuper easy! üéâ
                        <div class="icon-container">
                            <div class="icon-label">
                                <img src="/attachment-icon.png" alt="Attachment Icon" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <svg style="display: none;" viewBox="0 0 24 24" fill="#8b5cf6">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 2l5 5h-5V4zM6 20V4h6v6h6v10H6z"/>
                                </svg>
                                Attachment
                            </div>
                            <div class="icon-label">
                                <img src="/business-card-icon.png" alt="Business Card Icon" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <svg style="display: none;" viewBox="0 0 24 24" fill="#8b5cf6">
                                    <path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h16v12zM6 8h12v2H6V8zm0 4h12v2H6v-2z"/>
                                </svg>
                                Business Card
                            </div>
                            <div class="icon-label">
                                <img src="/photo-ocr-icon.png" alt="Photo OCR Icon" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <svg style="display: none;" viewBox="0 0 24 24" fill="#8b5cf6">
                                    <path d="M21 7h-6V5c0-1.1-.9-2-2-2H9c-1.1 0-2 .9-2 2v2H3c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h18c1.1 0 2-.9-2 2V9c0-1.1-.9-2-2-2zM9 5h4v2H9V5zm11 14H4V9h16v10z"/>
                                </svg>
                                Photo OCR
                            </div>
                        </div>
                        <input type="file" id="chat-file" accept="image/*,.pdf,.xlsx" style="display: none;">
                    </div>
                    <canvas id="sync-gauge" class="sync-gauge"></canvas>`;
                chatBody.insertBefore(message, document.getElementById('sync-gauge'));
                setupDragDrop();
                setupGauge();
                chatBody.scrollTop = chatBody.scrollHeight;
            } catch (e) {
                const errorMessage = document.createElement('div');
                errorMessage.className = 'chat-message bg-red-100';
                errorMessage.innerText = 'Turbulence: ' + e.message;
                chatBody.insertBefore(errorMessage, document.getElementById('sync-gauge'));
                chatBody.scrollTop = chatBody.scrollHeight;
            }
        }

        function setupDragDropArea() {
            document.getElementById('chat-body').innerHTML = `
                <div class="drag-drop-area" id="drag-drop-area">
                    Drop a photo, PDF, or Excel file here to scan or import‚Äîsuper easy! üéâ
                    <div class="icon-container">
                        <div class="icon-label">
                            <img src="/attachment-icon.png" alt="Attachment Icon" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <svg style="display: none;" viewBox="0 0 24 24" fill="#8b5cf6">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 2l5 5h-5V4zM6 20V4h6v6h6v10H6z"/>
                            </svg>
                            Attachment
                        </div>
                        <div class="icon-label">
                            <img src="/business-card-icon.png" alt="Business Card Icon" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <svg style="display: none;" viewBox="0 0 24 24" fill="#8b5cf6">
                                <path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h16v12zM6 8h12v2H6V8zm0 4h12v2H6v-2z"/>
                            </svg>
                            Business Card
                        </div>
                        <div class="icon-label">
                            <img src="/photo-ocr-icon.png" alt="Photo OCR Icon" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <svg style="display: none;" viewBox="0 0 24 24" fill="#8b5cf6">
                                <path d="M21 7h-6V5c0-1.1-.9-2-2-2H9c-1.1 0-2 .9-2 2v2H3c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h18c1.1 0 2-.9-2 2V9c0-1.1-.9-2-2-2zM9 5h4v2H9V5zm11 14H4V9h16v10z"/>
                            </svg>
                            Photo OCR
                        </div>
                    </div>
                    <input type="file" id="chat-file" accept="image/*,.pdf,.xlsx" style="display: none;">
                </div>
                <canvas id="sync-gauge" class="sync-gauge"></canvas>`;
            setupDragDrop();
            setupGauge();
        }

        function setupDragDrop() {
            const dragDropArea = document.getElementById('drag-drop-area');
            const fileInput = document.getElementById('chat-file');

            dragDropArea.addEventListener('click', () => fileInput.click());
            dragDropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                dragDropArea.classList.add('dragover');
            });
            dragDropArea.addEventListener('dragleave', () => dragDropArea.classList.remove('dragover'));
            dragDropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dragDropArea.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                handleFile(file);
            });
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                handleFile(file);
            });
        }

        async function handleFile(file) {
            const chatBody = document.getElementById('chat-body');
            if (!file) return;

            currentFile = file;

            if (mode === 'maverick') {
                const message = document.createElement('div');
                message.className = 'chat-message';
                message.innerText = 'Oops! Files are only supported in Goose mode‚Äîswitch over to scan or import! üòÑ';
                chatBody.insertBefore(message, document.getElementById('sync-gauge'));
                chatBody.scrollTop = chatBody.scrollHeight;
                return;
            }

            if (!token) {
                const tokenForm = document.createElement('div');
                tokenForm.className = 'dynamic-form';
                tokenForm.innerHTML = `
                    <input type="text" id="token-input" placeholder="Enter your RealNex Bearer Token">
                    <button onclick="validateToken()">Validate Token</button>
                `;
                chatBody.insertBefore(tokenForm, document.getElementById('sync-gauge'));
                chatBody.scrollTop = chatBody.scrollHeight;
                return;
            }

            const spinner = document.createElement('div');
            spinner.className = 'spinner';
            spinner.style.display = 'block';
            chatBody.insertBefore(spinner, document.getElementById('sync-gauge'));

            updateGauge(10);
            if (file.name.endsWith('.xlsx')) {
                const formData = new FormData();
                formData.append('file', file);
                try {
                    const res = await fetch('/suggest-mapping', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData
                    });
                    const data = await res.json();
                    updateGauge(50);
                    if (data.error) throw new Error(data.error);

                    const mappingForm = document.createElement('div');
                    mappingForm.className = 'dynamic-form';
                    mappingForm.innerHTML = `
                        <textarea id="mapping-json" rows="5">${JSON.stringify(data.suggestedMapping, null, 2)}</textarea>
                        <button onclick="submitMapping()">Import</button>`;
                    chatBody.innerHTML = '';
                    chatBody.appendChild(mappingForm);
                    chatBody.appendChild(document.getElementById('sync-gauge'));
                    updateGauge(100);
                    chatBody.scrollTop = chatBody.scrollHeight;
                } catch (e) {
                    const errorMessage = document.createElement('div');
                    errorMessage.className = 'chat-message bg-red-100';
                    errorMessage.innerText = 'Turbulence: ' + e.message;
                    chatBody.innerHTML = '';
                    chatBody.appendChild(errorMessage);
                    chatBody.appendChild(document.getElementById('sync-gauge'));
                    updateGauge(0);
                    chatBody.scrollTop = chatBody.scrollHeight;
                }
            } else {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('token', token);
                formData.append('notes', 'Scanned via Goose');

                try {
                    const res = await fetch('/upload-business-card', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();
                    updateGauge(50);
                    if (data.error) throw new Error(data.error);

                    const message = document.createElement('div');
                    message.className = 'chat-message bg-teal-100';
                    message.innerText = data.message;
                    chatBody.innerHTML = `
                        <div class="drag-drop-area" id="drag-drop-area">
                            Drop a photo, PDF, or Excel file here to scan or import‚Äîsuper easy! üéâ
                            <div class="icon-container">
                                <div class="icon-label">
                                    <img src="/attachment-icon.png" alt="Attachment Icon" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <svg style="display: none;" viewBox="0 0 24 24" fill="#8b5cf6">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 2l5 5h-5V4zM6 20V4h6v6h6v10H6z"/>
                                    </svg>
                                    Attachment
                                </div>
                                <div class="icon-label">
                                    <img src="/business-card-icon.png" alt="Business Card Icon" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <svg style="display: none;" viewBox="0 0 24 24" fill="#8b5cf6">
                                        <path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h16v12zM6 8h12v2H6V8zm0 4h12v2H6v-2z"/>
                                    </svg>
                                    Business Card
                                </div>
                                <div class="icon-label">
                                    <img src="/photo-ocr-icon.png" alt="Photo OCR Icon" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <svg style="display: none;" viewBox="0 0 24 24" fill="#8b5cf6">
                                        <path d="M21 7h-6V5c0-1.1-.9-2-2-2H9c-1.1 0-2 .9-2 2v2H3c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h18c1.1 0 2-.9-2 2V9c0-1.1-.9-2-2-2zM9 5h4v2H9V5zm11 14H4V9h16v10z"/>
                                    </svg>
                                    Photo OCR
                                </div>
                            </div>
                            <input type="file" id="chat-file" accept="image/*,.pdf,.xlsx" style="display: none;">
                        </div>
                        <canvas id="sync-gauge" class="sync-gauge"></canvas>`;
                    chatBody.insertBefore(message, document.getElementById('sync-gauge'));
                    updateGauge(100);
                    setupDragDrop();
                    chatBody.scrollTop = chatBody.scrollHeight;
                } catch (e) {
                    const errorMessage = document.createElement('div');
                    errorMessage.className = 'chat-message bg-red-100';
                    errorMessage.innerText = 'Turbulence: ' + e.message;
                    chatBody.innerHTML = `
                        <div class="drag-drop-area" id="drag-drop-area">
                            Drop a photo, PDF, or Excel file here to scan or import‚Äîsuper easy! üéâ
                            <div class="icon-container">
                                <div class="icon-label">
                                    <img src="/attachment-icon.png" alt="Attachment Icon" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <svg style="display: none;" viewBox="0 0 24 24" fill="#8b5cf6">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 2l5 5h-5V4zM6 20V4h6v6h6v10H6z"/>
                                    </svg>
                                    Attachment
                                </div>
                                <div class="icon-label">
                                    <img src="/business-card-icon.png" alt="Business Card Icon" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <svg style="display: none;" viewBox="0 0 24 24" fill="#8b5cf6">
                                        <path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h16v12zM6 8h12v2H6V8zm0 4h12v2H6v-2z"/>
                                    </svg>
                                    Business Card
                                </div>
                                <div class="icon-label">
                                    <img src="/photo-ocr-icon.png" alt="Photo OCR Icon" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <svg style="display: none;" viewBox="0 0 24 24" fill="#8b5cf6">
                                        <path d="M21 7h-6V5c0-1.1-.9-2-2-2H9c-1.1 0-2 .9-2 2v2H3c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h18c1.1 0 2-.9-2 2V9c0-1.1-.9-2-2-2zM9 5h4v2H9V5zm11 14H4V9h16v10z"/>
                                    </svg>
                                    Photo OCR
                                </div>
                            </div>
                            <input type="file" id="chat-file" accept="image/*,.pdf,.xlsx" style="display: none;">
                        </div>
                        <canvas id="sync-gauge" class="sync-gauge"></canvas>`;
                    chatBody.insertBefore(errorMessage, document.getElementById('sync-gauge'));
                    updateGauge(0);
                    setupDragDrop();
                    chatBody.scrollTop = chatBody.scrollHeight;
                }
            }
        }

        async function submitMapping() {
            const mappingJson = document.getElementById('mapping-json').value;
            const chatBody = document.getElementById('chat-body');
            const formData = new FormData();
            formData.append('file', currentFile);
            formData.append('token', token);
            formData.append('mapping', mappingJson);

            const spinner = document.createElement('div');
            spinner.className = 'spinner';
            spinner.style.display = 'block';
            chatBody.innerHTML = '';
            chatBody.appendChild(spinner);
            chatBody.appendChild(document.getElementById('sync-gauge'));
            updateGauge(10);

            try {
                const res = await fetch('/bulk-import', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                updateGauge(50);
                if (data.error) throw new Error(data.error);

                const message = document.createElement('div');
                message.className = 'chat-message bg-teal-100';
                message.innerText = `Imported ${data.processed} records! Results: ${JSON.stringify(data.results, null, 2)}`;
                chatBody.innerHTML = `
                    <div class="drag-drop-area" id="drag-drop-area">
                        Drop a photo, PDF, or Excel file here to scan or import‚Äîsuper easy! üéâ
                        <div class="icon-container">
                            <div class="icon-label">
                                <img src="/attachment-icon.png" alt="Attachment Icon" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <svg style="display: none;" viewBox="0 0 24 24" fill="#8b5cf6">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 2l5 5h-5V4zM6 20V4h6v6h6v10H6z"/>
                                </svg>
                                Attachment
                            </div>
                            <div class="icon-label">
                                <img src="/business-card-icon.png" alt="Business Card Icon" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <svg style="display: none;" viewBox="0 0 24 24" fill="#8b5cf6">
                                    <path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h16v12zM6 8h12v2H6V8zm0 4h12v2H6v-2z"/>
                                </svg>
                                Business Card
                            </div>
                            <div class="icon-label">
                                <img src="/photo-ocr-icon.png" alt="Photo OCR Icon" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <svg style="display: none;" viewBox="0 0 24 24" fill="#8b5cf6">
                                    <path d="M21 7h-6V5c0-1.1-.9-2-2-2H9c-1.1 0-2 .9-2 2v2H3c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h18c1.1 0 2-.9-2 2V9c0-1.1-.9-2-2-2zM9 5h4v2H9V5zm11 14H4V9h16v10z"/>
                                </svg>
                                Photo OCR
                            </div>
                        </div>
                        <input type="file" id="chat-file" accept="image/*,.pdf,.xlsx" style="display: none;">
                    </div>
                    <canvas id="sync-gauge" class="sync-gauge"></canvas>`;
                chatBody.insertBefore(message, document.getElementById('sync-gauge'));
                updateGauge(100);
                setupDragDrop();
                chatBody.scrollTop = chatBody.scrollHeight;
            } catch (e) {
                const errorMessage = document.createElement('div');
                errorMessage.className = 'chat-message bg-red-100';
                errorMessage.innerText = 'Turbulence: ' + e.message;
                chatBody.innerHTML = `
                    <div class="drag-drop-area" id="drag-drop-area">
                        Drop a photo, PDF, or Excel file here to scan or import‚Äîsuper easy! üéâ
                        <div class="icon-container">
                            <div class="icon-label">
                                <img src="/attachment-icon.png" alt="Attachment Icon" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <svg style="display: none;" viewBox="0 0 24 24" fill="#8b5cf6">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 2l5 5h-5V4zM6 20V4h6v6h6v10H6z"/>
                                </svg>
                                Attachment
                            </div>
                            <div class="icon-label">
                                <img src="/business-card-icon.png" alt="Business Card Icon" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <svg style="display: none;" viewBox="0 0 24 24" fill="#8b5cf6">
                                    <path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h16v12zM6 8h12v2H6V8zm0 4h12v2H6v-2z"/>
                                </svg>
                                Business Card
                            </div>
                            <div class="icon-label">
                                <img src="/photo-ocr-icon.png" alt="Photo OCR Icon" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <svg style="display: none;" viewBox="0 0 24 24" fill="#8b5cf6">
                                    <path d="M21 7h-6V5c0-1.1-.9-2-2-2H9c-1.1 0-2 .9-2 2v2H3c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h18c1.1 0 2-.9-2 2V9c0-1.1-.9-2-2-2zM9 5h4v2H9V5zm11 14H4V9h16v10z"/>
                                </svg>
                                Photo OCR
                            </div>
                        </div>
                        <input type="file" id="chat-file" accept="image/*,.pdf,.xlsx" style="display: none;">
                    </div>
                    <canvas id="sync-gauge" class="sync-gauge"></canvas>`;
                chatBody.insertBefore(errorMessage, document.getElementById('sync-gauge'));
                updateGauge(0);
                setupDragDrop();
                chatBody.scrollTop = chatBody.scrollHeight;
            }
        }

        async function validateToken() {
            const tokenInput = document.getElementById('token-input');
            const chatBody = document.getElementById('chat-body');
            const clearKeyButton = document.getElementById('clear-key');
            const toggleEventsButton = document.getElementById('toggle-events');
            const syncMailchimpButton = document.getElementById('sync-mailchimp');
            token = tokenInput.value.trim();

            const spinner = document.createElement('div');
            spinner.className = 'spinner';
            spinner.style.display = 'block';
            chatBody.innerHTML = '';
            chatBody.appendChild(spinner);
            chatBody.appendChild(document.getElementById('sync-gauge'));

            try {
                const res = await fetch('/validate-token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token })
                });
                const data = await res.json();
                if (data.valid) {
                    localStorage.setItem('realNexApiKey', token);
                    clearKeyButton.style.display = 'block';
                    toggleEventsButton.style.display = 'block';
                    syncMailchimpButton.style.display = 'block';
                    chatBody.innerHTML = `
                        <div class="drag-drop-area" id="drag-drop-area">
                            Drop a photo, PDF, or Excel file here to scan or import‚Äîsuper easy! üéâ
                            <div class="icon-container">
                                <div class="icon-label">
                                    <img src="/attachment-icon.png" alt="Attachment Icon" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <svg style="display: none;" viewBox="0 0 24 24" fill="#8b5cf6">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 2l5 5h-5V4zM6 20V4h6v6h6v10H6z"/>
                                    </svg>
                                    Attachment
                                </div>
                                <div class="icon-label">
                                    <img src="/business-card-icon.png" alt="Business Card Icon" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <svg style="display: none;" viewBox="0 0 24 24" fill="#8b5cf6">
                                        <path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h16v12zM6 8h12v2H6V8zm0 4h12v2H6v-2z"/>
                                    </svg>
                                    Business Card
                                </div>
                                <div class="icon-label">
                                    <img src="/photo-ocr-icon.png" alt="Photo OCR Icon" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <svg style="display: none;" viewBox="0 0 24 24" fill="#8b5cf6">
                                        <path d="M21 7h-6V5c0-1.1-.9-2-2-2H9c-1.1 0-2 .9-2 2v2H3c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h18c1.1 0 2-.9-2 2V9c0-1.1-.9-2-2-2zM9 5h4v2H9V5zm11 14H4V9h16v10z"/>
                                    </svg>
                                    Photo OCR
                                </div>
                            </div>
                            <input type="file" id="chat-file" accept="image/*,.pdf,.xlsx" style="display: none;">
                        </div>
                        <canvas id="sync-gauge" class="sync-gauge"></canvas>`;
                    setupDragDrop();
                    setupGauge();
                } else {
                    const errorMessage = document.createElement('div');
                    errorMessage.className = 'chat-message bg-red-100';
                    errorMessage.innerText = 'Invalid token! Try again, Goose!';
                    chatBody.innerHTML = `
                        <div class="dynamic-form">
                            <input type="text" id="token-input" placeholder="Enter your RealNex Bearer Token">
                            <button onclick="validateToken()">Validate Token</button>
                        </div>
                        <canvas id="sync-gauge" class="sync-gauge"></canvas>`;
                    chatBody.insertBefore(errorMessage, document.getElementById('sync-gauge'));
                    setupGauge();
                }
                chatBody.scrollTop = chatBody.scrollHeight;
            } catch (e) {
                const errorMessage = document.createElement('div');
                errorMessage.className = 'chat-message bg-red-100';
                errorMessage.innerText = 'Turbulence: ' + e.message;
                chatBody.innerHTML = `
                    <div class="dynamic-form">
                        <input type="text" id="token-input" placeholder="Enter your RealNex Bearer Token">
                        <button onclick="validateToken()">Validate Token</button>
                    </div>
                    <canvas id="sync-gauge" class="sync-gauge"></canvas>`;
                chatBody.insertBefore(errorMessage, document.getElementById('sync-gauge'));
                setupGauge();
                chatBody.scrollTop = chatBody.scrollHeight;
            }
        }

        async function sendMessage() {
            const messageInput = document.getElementById('chat-message');
            const message = messageInput.value.trim();
            const chatBody = document.getElementById('chat-body');
            if (!message) return;

            const userMessage = document.createElement('div');
            userMessage.className = 'chat-message';
            userMessage.innerText = message;
            chatBody.insertBefore(userMessage, document.getElementById('sync-gauge'));

            const spinner = document.createElement('div');
            spinner.className = 'spinner';
            spinner.style.display = 'block';
            chatBody.insertBefore(spinner, document.getElementById('sync-gauge'));

            try {
                const res = await fetch('/ask', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ message })
                });
                const data = await res.json();
                spinner.remove();
                const botMessage = document.createElement('div');
                botMessage.className = 'chat-message bg-purple-100';
                botMessage.innerText = data.answer || data.error;
                chatBody.insertBefore(botMessage, document.getElementById('sync-gauge'));
            } catch (e) {
                spinner.remove();
                const errorMessage = document.createElement('div');
                errorMessage.className = 'chat-message bg-red-100';
                errorMessage.innerText = 'Turbulence: ' + e.message;
                chatBody.insertBefore(errorMessage, document.getElementById('sync-gauge'));
            }
            messageInput.value = '';
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        let gaugeChart;
        function setupGauge() {
            const ctx = document.getElementById('sync-gauge').getContext('2d');
            gaugeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: ['#8b5cf6', '#e5e7eb'],
                        borderWidth: 0
                    }]
                },
                options: {
                    circumference: 180,
                    rotation: 270,
                    cutout: '80%',
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    }
                }
            });
        }

        function updateGauge(value) {
            gaugeChart.data.datasets[0].data = [value, 100 - value];
            gaugeChart.update();
        }
    </script>
</body>
</html>
