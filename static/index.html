<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goose & Maverick</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="/tailwind.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            font-family: 'Inter', sans-serif;
            color: #1f2937;
        }
        .chat-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 380px;
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }
        .chat-header {
            background: linear-gradient(to right, #8b5cf6, #22d3ee);
            color: white;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-header img, .chat-header svg {
            width: 24px;
            height: 24px;
            margin-right: 8px;
            transition: transform 0.3s ease;
        }
        .chat-header img:hover, .chat-header svg:hover {
            transform: scale(1.1);
        }
        .chat-body {
            padding: 16px;
            max-height: 400px;
            overflow-y: auto;
            background: #fafafa;
        }
        .chat-message {
            margin-bottom: 12px;
            padding: 10px 14px;
            border-radius: 12px;
            background: #f3f4f6;
            color: #1f2937;
            transition: all 0.3s ease;
        }
        .chat-message.bg-purple-100 {
            background: #8b5cf6;
            color: white;
        }
        .chat-message.bg-teal-100 {
            background: #14b8a6;
            color: white;
        }
        .chat-message.bg-red-100 {
            background: #ef4444;
            color: white;
        }
        .chat-input {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-top: 1px solid #e5e7eb;
            background: #ffffff;
        }
        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            margin-right: 8px;
            background: #f9fafb;
            color: #1f2937;
        }
        .chat-input input::placeholder {
            color: #6b7280;
        }
        .chat-input button {
            background: #8b5cf6;
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            transition: background 0.3s ease, transform 0.1s ease;
        }
        .chat-input button:hover {
            background: #a78bfa;
            transform: scale(1.03);
        }
        .switch-button {
            background: #ffffff;
            color: #8b5cf6;
            border: 1px solid #8b5cf6;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            transition: background 0.3s ease, transform 0.1s ease;
        }
        .switch-button:hover {
            background: #f3e8ff;
            transform: scale(1.03);
        }
        .drag-drop-area {
            border: 2px dashed #8b5cf6;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            margin-bottom: 12px;
            background: #f9fafb;
            color: #6b7280;
            transition: all 0.3s ease;
        }
        .drag-drop-area.dragover {
            background: #ede9fe;
            color: #8b5cf6;
            border-color: #a78bfa;
        }
        .dynamic-form {
            margin-bottom: 12px;
        }
        .dynamic-form input,
        .dynamic-form textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #f9fafb;
            color: #1f2937;
        }
        .dynamic-form input::placeholder,
        .dynamic-form textarea::placeholder {
            color: #6b7280;
        }
        .dynamic-form button {
            background: #14b8a6;
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            transition: background 0.3s ease, transform 0.1s ease;
        }
        .dynamic-form button:hover {
            background: #2dd4bf;
            transform: scale(1.03);
        }
    </style>
</head>
<body>
    <div class="chat-widget">
        <div class="chat-header">
            <div class="flex items-center">
                <img id="mode-icon" src="/maverick-icon.png" alt="Maverick Icon" onerror="this.style.display='none'; document.getElementById('maverick-svg').style.display='block';">
                <svg id="maverick-svg" style="display: none;" viewBox="0 0 24 24" fill="white">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                </svg>
                <span id="chat-title">Hey there! Chat with Maverick! ðŸš€</span>
            </div>
            <button id="switch-mode" class="switch-button" onclick="toggleMode()">Switch to Goose</button>
        </div>
        <div class="chat-body" id="chat-body">
            <div class="drag-drop-area" id="drag-drop-area">
                Drop a file here or click to uploadâ€”let's make magic! âœ¨
                <input type="file" id="chat-file" accept="" style="display: none;">
            </div>
        </div>
        <div class="chat-input">
            <input type="text" id="chat-message" placeholder="Type something exciting!" onkeypress="if(event.key === 'Enter') sendMessage()">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        let mode = 'maverick'; // 'maverick' or 'goose'
        let token = ''; // Store token for Goose mode
        let currentFile = null; // Store the current file being processed

        function toggleMode() {
            const switchButton = document.getElementById('switch-mode');
            const chatTitle = document.getElementById('chat-title');
            const modeIcon = document.getElementById('mode-icon');
            const maverickSvg = document.getElementById('maverick-svg');
            const dragDropArea = document.getElementById('drag-drop-area');
            if (mode === 'maverick') {
                mode = 'goose';
                chatTitle.innerText = 'Letâ€™s Scan with Goose! ðŸ“¸';
                switchButton.innerText = 'Switch to Maverick';
                modeIcon.src = '/goose-icon.png';
                modeIcon.alt = 'Goose Icon';
                modeIcon.onerror = () => {
                    modeIcon.style.display = 'none';
                    const gooseSvg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                    gooseSvg.setAttribute("viewBox", "0 0 24 24");
                    gooseSvg.setAttribute("fill", "white");
                    gooseSvg.innerHTML = '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>';
                    gooseSvg.classList.add('w-6', 'h-6', 'mr-2');
                    modeIcon.parentNode.insertBefore(gooseSvg, modeIcon);
                };
                maverickSvg.style.display = 'none';
                dragDropArea.innerText = 'Drop a photo, PDF, or Excel file here to scan or importâ€”super easy! ðŸŽ‰';
            } else {
                mode = 'maverick';
                chatTitle.innerText = 'Hey there! Chat with Maverick! ðŸš€';
                switchButton.innerText = 'Switch to Goose';
                modeIcon.src = '/maverick-icon.png';
                modeIcon.alt = 'Maverick Icon';
                modeIcon.onerror = () => {
                    modeIcon.style.display = 'none';
                    maverickSvg.style.display = 'block';
                };
                if (document.querySelector('svg:not(#maverick-svg)')) {
                    document.querySelector('svg:not(#maverick-svg)').remove();
                }
                dragDropArea.innerText = 'Drop a file here or click to uploadâ€”letâ€™s make magic! âœ¨';
            }
            document.getElementById('chat-body').innerHTML = `<div class="drag-drop-area" id="drag-drop-area">${dragDropArea.innerText}<input type="file" id="chat-file" accept="${mode === 'goose' ? 'image/*,.pdf,.xlsx' : ''}" style="display: none;"></div>`;
            setupDragDrop();
        }

        function setupDragDrop() {
            const dragDropArea = document.getElementById('drag-drop-area');
            const fileInput = document.getElementById('chat-file');

            dragDropArea.addEventListener('click', () => fileInput.click());
            dragDropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                dragDropArea.classList.add('dragover');
            });
            dragDropArea.addEventListener('dragleave', () => dragDropArea.classList.remove('dragover'));
            dragDropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dragDropArea.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                handleFile(file);
            });
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                handleFile(file);
            });
        }

        async function handleFile(file) {
            const chatBody = document.getElementById('chat-body');
            if (!file) return;

            currentFile = file;

            if (mode === 'maverick') {
                const message = document.createElement('div');
                message.className = 'chat-message';
                message.innerText = 'Oops! Files are only supported in Goose modeâ€”switch over to scan or import! ðŸ˜„';
                chatBody.appendChild(message);
                return;
            }

            if (!token) {
                const tokenForm = document.createElement('div');
                tokenForm.className = 'dynamic-form';
                tokenForm.innerHTML = `
                    <input type="text" id="token-input" placeholder="Enter your RealNex Bearer Token">
                    <button onclick="validateToken()">Validate Token</button>
                `;
                chatBody.appendChild(tokenForm);
                return;
            }

            if (file.name.endsWith('.xlsx')) {
                const formData = new FormData();
                formData.append('file', file);
                try {
                    const res = await fetch('/suggest-mapping', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();
                    if (data.suggestedMapping) {
                        const mappingForm = document.createElement('div');
                        mappingForm.className = 'dynamic-form';
                        mappingForm.innerHTML = `
                            <textarea id="mapping-input" rows="4">${JSON.stringify(data.suggestedMapping, null, 2)}</textarea>
                            <button onclick="bulkImport()">Import Excelâ€”Letâ€™s Go! ðŸš€</button>
                        `;
                        chatBody.appendChild(mappingForm);
                    } else {
                        throw new Error(data.error || 'Failed to suggest mapping');
                    }
                } catch (e) {
                    const errorMessage = document.createElement('div');
                    errorMessage.className = 'chat-message bg-red-100';
                    errorMessage.innerText = 'Uh-oh! Couldnâ€™t suggest mapping: ' + e.message;
                    chatBody.appendChild(errorMessage);
                }
            } else {
                const scanForm = document.createElement('div');
                scanForm.className = 'dynamic-form';
                scanForm.innerHTML = `
                    <textarea id="notes-input" rows="4" placeholder="Add some notes about this contact!"></textarea>
                    <button onclick="upload()">Scan & Importâ€”Awesome! ðŸŽ‰</button>
                `;
                chatBody.appendChild(scanForm);
            }
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        async function validateToken() {
            const tokenInput = document.getElementById('token-input');
            const tokenValue = tokenInput.value.trim();
            const chatBody = document.getElementById('chat-body');

            try {
                const res = await fetch('/validate-token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: tokenValue })
                });
                const data = await res.json();
                if (data.valid) {
                    token = tokenValue;
                    const tokenMessage = document.createElement('div');
                    tokenMessage.className = 'chat-message bg-teal-100';
                    tokenMessage.innerText = 'Woohoo! Token validatedâ€”ready to roll! ðŸŽˆ';
                    chatBody.innerHTML = `<div class="drag-drop-area" id="drag-drop-area">Drop a photo, PDF, or Excel file here to scan or importâ€”super easy! ðŸŽ‰<input type="file" id="chat-file" accept="image/*,.pdf,.xlsx" style="display: none;"></div>`;
                    chatBody.appendChild(tokenMessage);
                    setupDragDrop();
                } else {
                    const errorMessage = document.createElement('div');
                    errorMessage.className = 'chat-message bg-red-100';
                    errorMessage.innerText = 'Oh no! Invalid token: ' + (data.error || 'Unknown error');
                    chatBody.appendChild(errorMessage);
                }
            } catch (e) {
                const errorMessage = document.createElement('div');
                errorMessage.className = 'chat-message bg-red-100';
                errorMessage.innerText = 'Yikes! Error validating token: ' + e.message;
                chatBody.appendChild(errorMessage);
            }
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        async function sendMessage() {
            const messageInput = document.getElementById('chat-message');
            const message = messageInput.value.trim();
            const chatBody = document.getElementById('chat-body');
            if (!message) return;

            if (mode === 'maverick') {
                const userMessage = document.createElement('div');
                userMessage.className = 'chat-message';
                userMessage.innerText = message;
                chatBody.appendChild(userMessage);

                try {
                    const res = await fetch('/ask', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message })
                    });
                    const data = await res.json();
                    const botMessage = document.createElement('div');
                    botMessage.className = 'chat-message bg-purple-100';
                    botMessage.innerText = data.answer || JSON.stringify(data.error);
                    chatBody.appendChild(botMessage);
                } catch (e) {
                    const errorMessage = document.createElement('div');
                    errorMessage.className = 'chat-message bg-red-100';
                    errorMessage.innerText = 'Oops! Something went wrong: ' + e.message;
                    chatBody.appendChild(errorMessage);
                }
            } else {
                const tokenForm = document.createElement('div');
                tokenForm.className = 'dynamic-form';
                tokenForm.innerHTML = `
                    <input type="text" id="token-input" value="${message}" placeholder="Enter your RealNex Bearer Token">
                    <button onclick="validateToken()">Validate Token</button>
                `;
                chatBody.appendChild(tokenForm);
            }
            messageInput.value = '';
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        async function upload() {
            const file = currentFile;
            const notes = document.getElementById('notes-input').value;
            const chatBody = document.getElementById('chat-body');
            const formData = new FormData();
            formData.append('file', file);
            formData.append('token', token);
            formData.append('notes', notes);
            try {
                const res = await fetch('/upload-business-card', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                const resultMessage = document.createElement('div');
                resultMessage.className = 'chat-message bg-teal-100';
                resultMessage.innerText = 'Yes! Scan successful: ' + (data.followUpEmail || JSON.stringify(data.error));
                chatBody.innerHTML = `<div class="drag-drop-area" id="drag-drop-area">Drop a photo, PDF, or Excel file here to scan or importâ€”super easy! ðŸŽ‰<input type="file" id="chat-file" accept="image/*,.pdf,.xlsx" style="display: none;"></div>`;
                chatBody.appendChild(resultMessage);
                setupDragDrop();
            } catch (e) {
                const errorMessage = document.createElement('div');
                errorMessage.className = 'chat-message bg-red-100';
                errorMessage.innerText = 'Oh snap! Error: ' + e.message;
                chatBody.appendChild(errorMessage);
            }
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        async function bulkImport() {
            const file = currentFile;
            const mapping = document.getElementById('mapping-input').value;
            const chatBody = document.getElementById('chat-body');
            const formData = new FormData();
            formData.append('file', file);
            formData.append('token', token);
            formData.append('mapping', mapping);
            try {
                const res = await fetch('/bulk-import', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                const resultMessage = document.createElement('div');
                resultMessage.className = 'chat-message bg-teal-100';
                resultMessage.innerText = `Boom! Imported ${data.processed || 0} recordsâ€”nice work! ðŸŽ‰`;
                chatBody.innerHTML = `<div class="drag-drop-area" id="drag-drop-area">Drop a photo, PDF, or Excel file here to scan or importâ€”super easy! ðŸŽ‰<input type="file" id="chat-file" accept="image/*,.pdf,.xlsx" style="display: none;"></div>`;
                chatBody.appendChild(resultMessage);
                setupDragDrop();
            } catch (e) {
                const errorMessage = document.createElement('div');
                errorMessage.className = 'chat-message bg-red-100';
                errorMessage.innerText = 'Whoops! Error: ' + e.message;
                chatBody.appendChild(errorMessage);
            }
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        // Letâ€™s kick things off!
        setupDragDrop();
    </script>
</body>
</html>
